---
title: nginx 安装和配置文件
date: 2018-06-21 16:45:10
tags:
    - nginx
categories:
    - 环境配置
    - nginx
---

@[TOC]

在常规的使用过程中， nginx 是经常会要用到的一种服务软件，其给基于 web 的服务系统，提供了很大的便利，以及相关方面的基础支持。本文记录一下，在 linux 环境下，安装和配置 nginx 服务的过程。

<!-- more -->

## 1 nginx 安装
基础工作的基础，就是先要会安装软件本身—— nginx ，一般分为两种，一种是下载源码包，自行编译安装；另一种，则是通过 yum 源安装。
在 {% post_link centos-yum-repository CentOS yum 源 %} 一文中，有提到关于 nginx 源如何添加的方法，这里不再赘叙，不清楚的，可以查看相应的文章。
添加源完成后，剩下的安装操作就很简单了：
```bash
# 默认安装的是源中最新的版本
# 同样也可以指定版本安装，前提需要你先去 packages 中查看存在某一具体版本
yum install nginx -y
```

## 2 nginx 配置
安装成功后，我们仍需要对其进行相关配置，以满足我们的相关应用需求。

### 2.1 配置文件 `nginx.conf`
nginx 配置文件主要分为四部分：

- `main` ：全局配置
- `server` ：主机配置
- `upstream` ：上游服务器配置，主要是：反向代理、负载均衡相关配置
- `location` ：URL 路由匹配规则配置

其中 `main` 部分的配置指令，会在全局范围内产生作用，从而影响其他所有部分的配置；`server` 部分的配置，主要用于指定虚拟主机域名、IP 和端口；`upstream` 用于配置一系列的后端服务器，配置反向代理及后端服务器的负载均衡；`location` 部分用于配置匹配页面访问规则（如，根目录：`/`，`/images`，等）。
这几部分之间的关系是：`server` 继承 `main`，`location` 继承 `server`；`upstream` 既不会继承其他配置也不会被继承，其有一套自身特有的配置。

### 2.2 常用配置说明
在配置 nginx 时，一般简单的应用，只需要配置很少量的，常见的几个配置参数即可，以下对于常见的一些配置进行说明记录。

#### 2.2.1 `main` 全局配置
nginx 在运行时，与具体业务功能（如 http 服务或是 email 服务代理等）无关的一些参数，如：工作进程数、运行的身份等。

- `worker_processes 2`
  在配置文件的顶部 `main` 部分，worker 角色的工作进程的个数，master 进程是接收并分配请求给 worker 处理。这个数值简单点可以配置为 CPU 的核心数（`grep ^processor /proc/cpuinfo | wc -l`），也是 auto 值，如果开启了 ssl 和 gzip ，则更应该设置成与逻辑 CPU 数量一致甚至为 2 倍，可以减少 I/O 操作，如若 nginx 服务器还有其它服务运行，可以适当的考虑减少。
- `worker_cpu_affinity`
  同样配置在 `main` 部分。在高并发场景下，通过配置 CPU 粘性来降低由于多 CPU 核心切换造成的寄存器等现场重建带来的性能损耗。如：`worker_cpu_affinity 0001 0010 0100 1000;` （四核）。
